---
import { appendBaseUrl } from "@/utils";
import { getI18N } from "@/i18n";
import { ThemeSwitcher } from "../ThemeSwitcher";
import { Menu, X } from "@lucide/astro";
import { Link } from "../Link";

const { lang } = Astro.props;

const languageUrl = lang === "es" ? appendBaseUrl("/en") : appendBaseUrl("");
const languageCaption = lang === "es" ? "EN" : "ES";
const flagUrl = appendBaseUrl(lang === "es" ? "/usa.svg" : "/mexico.svg");
const { COMPONENTS, HEADER_MENU_CAPTION, HEADER_PAGE_VERSION_CAPTION } =
  getI18N(lang);
const { HEADER } = COMPONENTS;
---

<header
  id="header"
  class="border-b w-full p-2 h-16 flex justify-between items-center bg-white dark:bg-black_rain dark:border-b-black_rain-900 dark:text-white"
>
  <section class="flex items-center gap-1">
    <img src="/og-image.jpg" width="32" class="" alt="Jorge A Macias Z" />

    <h1 class="font-bold">Jorge Macias</h1>
  </section>

  <ul class="hidden md:flex md:items-center">
    {
      HEADER.map(({ label, url }) => {
        return <Link label={label} url={url} />;
      })
    }
  </ul>

  <section class="hidden md:flex md:items-center md:justify-between gap-4">
    <div class="p-2 flex items-center justify-between gap-1">
      <ThemeSwitcher client:only="react" />

      <a class="flex items-center gap-2 py-1" href={languageUrl}>
        <img
          width={32}
          height={32}
          src={flagUrl}
          alt={`${
            lang === "es"
              ? "usa flag for lang change"
              : "mexico flag for lang change"
          }`}
        />

        {languageCaption}
      </a>
    </div>
  </section>

  <section
    id="mobile-menu"
    class="fixed w-full min-h-dvh h-full hidden md:hidden bg-black/60 inset-0 backdrop-blur-sm"
  >
    <nav
      id="mobile-menu-content"
      class="flex flex-col bg-white dark:bg-black_rain w-8/12 h-full transition-all duration-300 ease-in-out transform translate-x-[-100%]"
    >
      <section
        class="flex items-center gap-1 border-b bg-white dark:bg-black_rain dark:border-b-black_rain-900 p-4 justify-between"
      >
        <div class="flex items-center gap-1">
          <img src="/og-image.jpg" width="32" class="" alt="Jorge A Macias Z" />

          <h1 class="font-bold">Jorge Macias</h1>
        </div>

        <button type="button" class="menu-opener">
          <Menu size={32} />
          <X class="hidden hover:text-red-500" size={32} />
        </button>
      </section>

      <div
        class="p-2 border-b bg-white dark:bg-black_rain dark:border-b-black_rain-900 flex items-center justify-between"
      >
        <ThemeSwitcher client:only="react" />

        <a class="flex items-center gap-2 py-1" href={languageUrl}>
          <img
            width={32}
            height={32}
            src={flagUrl}
            alt={`${
              lang === "es"
                ? "usa flag for lang change"
                : "mexico flag for lang change"
            }`}
          />

          {languageCaption}
        </a>
      </div>

      <ul
        class="p-2 border-b bg-white dark:bg-black_rain dark:border-b-black_rain-900"
      >
        {
          HEADER.map(({ label, url }) => {
            return <Link label={label} url={url} />;
          })
        }
      </ul>

      <section
        class="p-4 border-b bg-white dark:bg-black_rain dark:border-b-black_rain-900"
      >
        {
          import.meta.env.PUBLIC_VERSION !== undefined && (
            <p class="text-xs">
              {HEADER_PAGE_VERSION_CAPTION}{" "}
              {lang === "es" ? "versi√≥n" : "version"}{" "}
              {import.meta.env.PUBLIC_VERSION}
            </p>
          )
        }
      </section>
    </nav>
  </section>

  <section class="md:hidden flex items-center">
    <button type="button" class="menu-opener">
      <Menu size={32} />
      <X class="hidden hover:text-red-500" size={32} />
    </button>
  </section>
</header>

<script is:inline>
  document.addEventListener("DOMContentLoaded", () => {
    const menuButtons = document.querySelectorAll(".menu-opener");
    const mobileMenu = document.getElementById("mobile-menu");
    const menuContent = document.getElementById("mobile-menu-content");
    const menuIcons = document.querySelectorAll(".lucide.lucide-menu");
    const closeIcons = document.querySelectorAll(".lucide.lucide-x");

    let isMenuOpen = false;

    const toggleMenu = () => {
      isMenuOpen = !isMenuOpen;

      menuIcons.forEach((icon) => icon.classList.toggle("hidden", isMenuOpen));

      closeIcons.forEach((icon) =>
        icon.classList.toggle("hidden", !isMenuOpen)
      );

      if (isMenuOpen) {
        mobileMenu.classList.remove("hidden");
        setTimeout(() => {
          menuContent.classList.remove("translate-x-[-100%]");
        }, 20);
      } else {
        menuContent.classList.add("translate-x-[-100%]");

        setTimeout(() => {
          mobileMenu.classList.add("hidden");
        }, 300);
      }

      document.documentElement.style.overflow = isMenuOpen ? "hidden" : "";
    };

    menuButtons.forEach((btn) => btn.addEventListener("click", toggleMenu));

    mobileMenu.addEventListener("click", (e) => {
      if (e.target === mobileMenu) {
        toggleMenu();
      }
    });
  });
</script>

<script is:inline>
  document.addEventListener("DOMContentLoaded", () => {
    const headerEl = document.getElementById("header");
    let ticking = false;
    const glassClasses = [
      "fixed",
      "top-0",
      "left-0",
      "right-0",
      "z-40",
      "backdrop-blur-md",
      "bg-white/90",
      "dark:bg-[#212529]/90",
      "border-b-white/20",
      "dark:border-b-[#070708]/50",
    ];

    const applyScrollEffects = () => {
      const currentScroll = window.scrollY;

      if (currentScroll > 20) {
        glassClasses.forEach((c) => headerEl.classList.add(c));

        headerEl.classList.add("w-full", "px-4");
      } else {
        glassClasses.forEach((c) => headerEl.classList.remove(c));

        headerEl.classList.add("bg-white", "dark:bg-black_rain");
      }

      ticking = false;
    };

    const handleScroll = () => {
      if (!ticking) {
        window.requestAnimationFrame(applyScrollEffects);
        ticking = true;
      }
    };

    window.addEventListener("scroll", handleScroll);

    applyScrollEffects();
  });
</script>

<script is:inline>
  document.addEventListener("DOMContentLoaded", () => {
    const mobileMenu = document.getElementById("mobile-menu");
    const menuContent = document.getElementById("mobile-menu-content");
    const menuIcons = document.querySelectorAll(".lucide.lucide-menu");
    const closeIcons = document.querySelectorAll(".lucide.lucide-x");

    let touchStartX = 0;
    let touchEndX = 0;
    const swipeThreshold = 50;

    const openMenu = () => {
      mobileMenu.classList.remove("hidden");

      menuIcons.forEach((icon) => icon.classList.toggle("hidden", true));
      closeIcons.forEach((icon) => icon.classList.toggle("hidden", false));

      setTimeout(() => {
        menuContent.classList.remove("translate-x-[-100%]");
      }, 20);

      document.documentElement.style.overflow = "hidden";
    };

    const closeMenu = () => {
      menuContent.classList.add("translate-x-[-100%]");

      menuIcons.forEach((icon) => icon.classList.toggle("hidden", false));
      closeIcons.forEach((icon) => icon.classList.toggle("hidden", true));

      setTimeout(() => {
        mobileMenu.classList.add("hidden");
        document.documentElement.style.overflow = "";
      }, 300);
    };

    const handleTouchStart = (e) => {
      touchStartX = e.changedTouches[0].screenX;
    };

    const handleTouchEnd = (e) => {
      if (window.innerWidth >= 768) return;

      touchEndX = e.changedTouches[0].screenX;

      const diffX = touchEndX - touchStartX;

      if (diffX < -swipeThreshold) {
        closeMenu();
      }

      if (diffX > swipeThreshold) {
        openMenu();
      }
    };

    document.addEventListener("touchstart", handleTouchStart, {
      passive: true,
    });

    document.addEventListener("touchend", handleTouchEnd, { passive: true });
  });
</script>
