---
import { getTranslation } from "@/i18n";
import type { Locale } from "@/types";
import { appendBaseUrl } from "@/utils";
import Link from "./Link.astro";
import { Menu, X } from "@lucide/astro";
import { ThemeToggler } from "./ThemeToggler";

const { currentLocale } = Astro;
const { t } = getTranslation(currentLocale as Locale);

const sections = t("sections");
const languageUrl = t("components.header.languageUrl");
const flagUrl = t("components.header.flagUrl");
const languageCaption = t("components.header.languageCaption");
const lang = currentLocale;
---

<header
  id="header"
  class="sticky z-50 backdrop-blur-sm top-0 border-b dark:border-dark-500 bg-white dark:bg-dark-800"
>
  <nav
    class="p-4 max-w-6xl mx-auto hidden md:flex justify-between items-center"
  >
    <a
      class="font-bold cursor-pointer text-xl hover:text-accent-700 dark:hover:text-accent-600"
      href={appendBaseUrl("/")}>{t("site.author_shortname")}</a
    >

    <ul class="flex items-center gap-4">
      {
        sections.map((el) => {
          return <Link isForElement {...el} />;
        })
      }
    </ul>

    <section class="flex items-center gap-4">
      <a class="flex items-center gap-2 py-1" href={appendBaseUrl(languageUrl)}>
        <img
          width={32}
          height={32}
          src={flagUrl}
          alt={`${
            lang === "es"
              ? "usa flag for lang change"
              : "mexico flag for lang change"
          }`}
        />

        {languageCaption}
      </a>
      <ThemeToggler client:only="react" />
    </section>
  </nav>

  <nav class="p-4 flex items-center justify-between md:hidden">
    <a
      class="font-bold cursor-pointer text-xl hover:text-accent-700 dark:hover:text-accent-600"
      href={appendBaseUrl("/")}>{t("site.author_shortname")}</a
    >

    <button
      title={t("components.header.menu_opener_title")}
      type="button"
      class="menu-opener"
      aria-label={t("components.header.menu_opener_title")}
    >
      <Menu size={32} />
      <X class="hidden hover:text-red-500" size={32} />
    </button>
  </nav>

  <section
    id="mobile-menu"
    class="fixed w-full min-h-dvh h-full md:hidden bg-black/80 inset-0 backdrop-blur-sm z-50"
    style="display: none;"
  >
    <nav
      id="mobile-menu-content"
      class="flex flex-col justify-between bg-white dark:bg-dark-800 w-8/12 h-full transition-all duration-300 ease-in-out transform -translate-x-full"
    >
      <section
        class="flex justify-between items-center p-4 border-b dark:border-dark-500"
      >
        <a
          class="font-bold cursor-pointer text-xl hover:text-accent-700 dark:hover:text-accent-600"
          href={appendBaseUrl("/")}>{t("site.author_shortname")}</a
        >

        <button type="button" class="menu-opener" aria-label="" name="">
          <Menu size={32} />
          <X class="hidden hover:text-red-500" size={32} />
        </button>
      </section>

      <section class="flex flex-col gap-4 flex-1 divide-y">
        <div class="flex p-4 pb-0 items-center justify-between">
          <a
            class="flex items-center gap-2 py-1"
            href={appendBaseUrl(languageUrl)}
          >
            <img
              width={32}
              height={32}
              src={flagUrl}
              alt={`${
                lang === "es"
                  ? "usa flag for lang change"
                  : "mexico flag for lang change"
              }`}
            />

            {languageCaption}
          </a>
          <ThemeToggler client:only="react" />
        </div>
        <ul class="flex flex-col p-4 gap-2 dark:border-dark-500 flex-1">
          {
            sections.map((el) => {
              return <Link isForElement isForMenu {...el} />;
            })
          }
        </ul>
      </section>

      <footer class="p-4 border-t dark:border-dark-500">
        {
          import.meta.env.PUBLIC_VERSION !== undefined && (
            <p class="text-xs">
              {t("components.header.version_title")}
              {import.meta.env.PUBLIC_VERSION}
            </p>
          )
        }
      </footer>
    </nav>
  </section>
</header>

<script is:inline>
  document.addEventListener("DOMContentLoaded", () => {
    const headerEl = document.getElementById("header");
    const mobileMenu = document.getElementById("mobile-menu");
    const menuContent = document.getElementById("mobile-menu-content");
    const menuButtons = document.querySelectorAll(".menu-opener");
    const menuIcons = document.querySelectorAll(".lucide.lucide-menu");
    const closeIcons = document.querySelectorAll(".lucide.lucide-x");

    let isMenuOpen = false;
    let touchStartX = 0;
    let touchStartY = 0;
    let isSwipingHorizontally = false;
    const swipeThreshold = 80;

    const glassClasses = [
      "fixed",
      "top-0",
      "left-0",
      "right-0",
      "z-50",
      "backdrop-blur-md",
      "bg-white/80",
      "dark:bg-dark-800/80",
      "dark:border-b-[#070708]/50",
    ];

    const headerObserver = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          const shouldApplyGlass = !entry.isIntersecting;
          glassClasses.forEach((c) => {
            headerEl.classList.toggle(c, shouldApplyGlass);
          });

          if (shouldApplyGlass) {
            headerEl.classList.add("w-full", "px-4");
          } else {
            headerEl.classList.add("bg-white", "dark:bg-black_rain");
          }
        });
      },
      { threshold: 0.1, rootMargin: "20px 0px 0px 0px" }
    );

    const triggerElement = document.createElement("div");
    triggerElement.style.position = "absolute";
    triggerElement.style.top = "0";
    triggerElement.style.height = "1px";
    triggerElement.style.width = "100%";
    triggerElement.style.pointerEvents = "none";
    document.body.prepend(triggerElement);
    headerObserver.observe(triggerElement);

    const toggleMenu = (shouldOpen) => {
      if (typeof shouldOpen === "boolean") {
        if (shouldOpen === isMenuOpen) return;
        isMenuOpen = shouldOpen;
      } else {
        isMenuOpen = !isMenuOpen;
      }

      menuIcons.forEach((icon) => icon.classList.toggle("hidden", isMenuOpen));
      closeIcons.forEach((icon) =>
        icon.classList.toggle("hidden", !isMenuOpen)
      );

      if (isMenuOpen) {
        mobileMenu.style.display = "block";
        requestAnimationFrame(() => {
          requestAnimationFrame(() => {
            menuContent.classList.remove("-translate-x-full");
          });
        });
      } else {
        menuContent.classList.add("-translate-x-full");
        setTimeout(() => {
          mobileMenu.style.display = "none";
        }, 300);
      }

      document.documentElement.style.overflow = isMenuOpen ? "hidden" : "";
    };

    const handleTouchStart = (e) => {
      if (window.innerWidth >= 768) return;

      touchStartX = e.touches[0].clientX;
      touchStartY = e.touches[0].clientY;
      isSwipingHorizontally = false;
    };

    const handleTouchMove = (e) => {
      if (window.innerWidth >= 768) return;

      const touchX = e.touches[0].clientX;
      const touchY = e.touches[0].clientY;
      const diffX = touchX - touchStartX;
      const diffY = touchY - touchStartY;

      if (!isSwipingHorizontally) {
        if (Math.abs(diffX) > Math.abs(diffY)) {
          isSwipingHorizontally = true;
        }
      }

      if (isSwipingHorizontally && Math.abs(diffX) > 10) {
        e.preventDefault();
      }
    };

    const handleTouchEnd = (e) => {
      if (window.innerWidth >= 768) return;

      const touchEndX = e.changedTouches[0].clientX;
      const diffX = touchEndX - touchStartX;

      if (Math.abs(diffX) > swipeThreshold) {
        if (diffX > 0 && !isMenuOpen) {
          toggleMenu(true);
        } else if (diffX < 0 && isMenuOpen) {
          toggleMenu(false);
        }
      }
    };

    menuButtons.forEach((btn) =>
      btn.addEventListener("click", () => toggleMenu())
    );
    mobileMenu.addEventListener(
      "click",
      (e) => e.target === mobileMenu && toggleMenu(false)
    );

    document.addEventListener("touchstart", handleTouchStart, {
      passive: false,
    });
    document.addEventListener("touchmove", handleTouchMove, { passive: false });
    document.addEventListener("touchend", handleTouchEnd, { passive: true });

    window.addEventListener("beforeunload", () => {
      headerObserver.unobserve(triggerElement);
      document.removeEventListener("touchstart", handleTouchStart);
      document.removeEventListener("touchmove", handleTouchMove);
      document.removeEventListener("touchend", handleTouchEnd);
    });
  });
</script>
